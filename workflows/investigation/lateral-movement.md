# Lateral Movement Detection Workflow

This workflow provides a systematic approach to detecting lateral movement techniques using LimaCharlie MCP and LCQL queries.

> **⚠️ IMPORTANT NOTES:**
> - Detection effectiveness varies by environment and configuration
> - Start with simple queries and iterate based on results
> - Not all techniques will yield results in every environment
> - Confidence levels are based on universal applicability and testing

## 1. Administrative Share Access Detection [HIGH CONFIDENCE]

**This is the most reliable lateral movement detection method** - Event ID 5140 is generated by Windows when network shares are accessed.

### Basic Query for Admin Shares
```lcql
-72h | * | WEL | event/EVENT/System/EventID == "5140" AND (event/EVENT/EventData/ShareName == "\\\\*\\ADMIN$" OR event/EVENT/EventData/ShareName == "\\\\*\\C$" OR event/EVENT/EventData/ShareName == "\\\\*\\D$") | event/EVENT/EventData/ShareName as Share event/EVENT/EventData/IpAddress as SourceIP event/EVENT/EventData/SubjectUserName as User routing/hostname as Host ts as Timestamp
```

### Analyze Patterns
```lcql
-72h | * | WEL | event/EVENT/System/EventID == "5140" AND (event/EVENT/EventData/ShareName == "\\\\*\\ADMIN$" OR event/EVENT/EventData/ShareName == "\\\\*\\C$") | event/EVENT/EventData/SubjectUserName as User event/EVENT/EventData/IpAddress as SourceIP COUNT_UNIQUE(routing/hostname) as TargetsAccessed GROUP BY(User, SourceIP) ORDER BY TargetsAccessed DESC
```

## 2. Remote Execution Detection

### PsExec and Similar Tools

#### Method 1: Registry-Based Detection (EULA Acceptance) [HIGH CONFIDENCE]

**This is the most reliable method for detecting PsExec usage**, even when the binary is renamed.

```lcql
-72h | * | REGISTRY_WRITE | event/REGISTRY_KEY contains "Sysinternals\\PsExec\\EulaAccepted" | event/REGISTRY_KEY as RegKey event/PROCESS_ID as PID routing/hostname as Host ts as Timestamp
```

**Why this works:** PsExec writes to the registry when `-accepteula` is used, regardless of binary name.

#### Method 2: Command Line with -accepteula [MEDIUM-HIGH CONFIDENCE]

```lcql
-24h | * | NEW_PROCESS | event/COMMAND_LINE contains "-accepteula" AND (event/COMMAND_LINE contains "\\\\" OR event/COMMAND_LINE contains "-c") | event/FILE_PATH as Process event/COMMAND_LINE as CommandLine event/PROCESS_ID as PID routing/hostname as Host
```

#### Method 3: Direct Binary Detection [LOW CONFIDENCE]
```lcql
-72h | plat == windows | NEW_PROCESS | event/FILE_PATH contains "psexec" OR event/FILE_PATH contains "paexec" OR event/FILE_PATH contains "remcom" OR event/FILE_PATH contains "psexesvc" | event/FILE_PATH as Tool event/COMMAND_LINE as Command event/USER_NAME as User routing/hostname as Host
```

#### Method 4: PsExec Service Detection [MEDIUM CONFIDENCE]
```lcql
-72h | plat == windows | WEL | event/EVENT/System/EventID == "7045" AND (event/EVENT/EventData/ServiceName contains "PSEXESVC" OR event/EVENT/EventData/ServiceName contains "psexec" OR event/EVENT/EventData/ImagePath contains "PSEXESVC") | event/EVENT/EventData/ServiceName as ServiceName event/EVENT/EventData/ImagePath as ServicePath routing/hostname as Host
```

#### Method 5: CODE_IDENTITY Detection (Renamed PsExec) [HIGHEST CONFIDENCE]

**This is the most reliable method for detecting renamed PsExec, regardless of filename.**

```lcql
-72h | * | CODE_IDENTITY | event/ORIGINAL_FILE_NAME == "psexec.c" | event/FILE_PATH as RenamedPath event/HASH as SHA256 event/PROCESS_ID as PID routing/hostname as Host ts as Timestamp
```

```lcql
# Detect lateral movement tools by original name in suspicious locations
-72h | * | CODE_IDENTITY |
(event/ORIGINAL_FILE_NAME == "psexec.c" OR 
 event/ORIGINAL_FILE_NAME == "paexec.exe" OR
 event/ORIGINAL_FILE_NAME == "remcom.exe") AND
(event/FILE_PATH contains "\\Temp\\" OR 
 event/FILE_PATH contains "\\ProgramData\\") |
event/FILE_PATH as SuspiciousPath 
event/ORIGINAL_FILE_NAME as ActualTool
event/HASH as FileHash
routing/hostname as Host
```

**Why this works:** CODE_IDENTITY events contain the ORIGINAL_FILE_NAME field which reveals the true identity of the binary regardless of renaming. This catches renamed PsExec even when attackers use single-letter names like p.exe.

#### Method 6: Behavioral Detection (Renamed PsExec) [LOW CONFIDENCE]
```lcql
-72h | plat == windows | NEW_PROCESS | event/PARENT/FILE_PATH contains "services.exe" AND event/USER_NAME == "SYSTEM" AND event/FILE_PATH contains "Windows" AND (event/COMMAND_LINE contains "-accepteula" OR event/COMMAND_LINE contains "-nobanner" OR event/COMMAND_LINE contains "-s cmd" OR event/COMMAND_LINE contains "-i cmd" OR event/COMMAND_LINE contains "-h cmd") | event/FILE_PATH as Process event/COMMAND_LINE as Command routing/hostname as Host
```

#### Method 6: Named Pipe Detection [MEDIUM CONFIDENCE - Requires Sysmon]
```lcql
-72h | plat == windows | WEL | event/EVENT/System/Channel == "Microsoft-Windows-Sysmon/Operational" AND (event/EVENT/System/EventID == "17" OR event/EVENT/System/EventID == "18") AND (event/EVENT/EventData/PipeName contains "\\PSEXESVC" OR event/EVENT/EventData/PipeName contains "\\RemCom" OR event/EVENT/EventData/PipeName contains "\\paexec") | event/EVENT/EventData/PipeName as PipeName event/EVENT/EventData/Image as Process routing/hostname as Host
```

#### Method 7: Command Line Pattern Detection [LOW CONFIDENCE]
```lcql
-72h | plat == windows | NEW_PROCESS | (event/COMMAND_LINE contains "\\\\*\\admin$" OR event/COMMAND_LINE contains "\\\\*\\c$" OR event/COMMAND_LINE contains "\\\\*\\ADMIN$" OR event/COMMAND_LINE contains "\\\\*\\C$") AND (event/COMMAND_LINE contains ".exe" OR event/COMMAND_LINE contains "cmd" OR event/COMMAND_LINE contains "powershell") | event/FILE_PATH as Tool event/COMMAND_LINE as Command event/USER_NAME as User routing/hostname as Host
```

### WMIC Remote Execution [MEDIUM CONFIDENCE]
```lcql
-24h | plat == windows | NEW_PROCESS | event/FILE_PATH contains "wmic.exe" AND event/COMMAND_LINE contains "/node:" | event/COMMAND_LINE as Command event/USER_NAME as User routing/hostname as SourceHost
```

## 3. Authentication Analysis [HIGH CONFIDENCE]

Windows authentication events are reliable indicators when properly configured.

### Remote Desktop (RDP) Connections [HIGH CONFIDENCE]

#### Successful RDP Logons
```lcql
-24h | plat == windows | WEL | event/EVENT/System/EventID == "4624" AND event/EVENT/EventData/LogonType == "10" | event/EVENT/EventData/TargetUserName as User event/EVENT/EventData/IpAddress as SourceIP routing/hostname as TargetHost ts as Timestamp
```

#### Failed RDP Attempts (Brute Force Detection)
```lcql
-1h | plat==windows | WEL | event/EVENT/System/EventID == "4625" AND event/EVENT/EventData/LogonType == "10" | event/EVENT/EventData/IpAddress as SourceIP event/EVENT/EventData/TargetUserName as TargetUser COUNT(event) as FailedAttempts GROUP BY(SourceIP, TargetUser) ORDER BY FailedAttempts DESC
```

**Why This Matters:**
- Multiple failed RDP attempts indicate brute force attacks
- Failed attempts followed by success suggest compromised credentials
- Unusual source IPs for RDP warrant investigation

### Network Logons (Type 3) [HIGH CONFIDENCE]
```lcql
-24h | plat == windows | WEL | event/EVENT/System/EventID == "4624" AND event/EVENT/EventData/LogonType == "3" AND event/EVENT/EventData/IpAddress not contains "127.0.0.1" | event/EVENT/EventData/TargetUserName as User event/EVENT/EventData/IpAddress as SourceIP event/EVENT/EventData/WorkstationName as SourceHost routing/hostname as TargetHost
```

## 4. Service Creation Detection [MEDIUM-HIGH CONFIDENCE]

### New Service Installation
```lcql
-24h | plat == windows | WEL | event/EVENT/System/EventID == "4697" OR event/EVENT/System/EventID == "7045" | event/EVENT/EventData/ServiceName as NewService event/EVENT/EventData/ServiceFileName as ServicePath event/EVENT/EventData/SubjectUserName as InstalledBy routing/hostname as Host
```

## 5. Scheduled Task Creation [MEDIUM CONFIDENCE]

### Remote Scheduled Tasks
```lcql
-24h | plat == windows | WEL | event/EVENT/System/EventID == "4698" | event/EVENT/EventData/TaskName as TaskName event/EVENT/EventData/SubjectUserName as Creator routing/hostname as Host
```

## 6. Suspicious Process Chains [MEDIUM CONFIDENCE]

### cmd.exe spawning from services
```lcql
-24h | plat == windows | NEW_PROCESS | event/FILE_PATH contains "cmd.exe" AND event/PARENT/FILE_PATH contains "services.exe" | event/COMMAND_LINE as Command event/PARENT/FILE_PATH as Parent routing/hostname as Host
```

## 7. Correlation Query [VARIABLE CONFIDENCE]

### Combined Lateral Movement Indicators
```lcql
-24h | * | WEL NEW_PROCESS | (event/EVENT/System/EventID == "5140" AND event/EVENT/EventData/ShareName contains "$") OR (event/EVENT/System/EventID == "4624" AND event/EVENT/EventData/LogonType == "3") OR (event/FILE_PATH contains "psexec") OR (event/FILE_PATH contains "wmic.exe" AND event/COMMAND_LINE contains "/node:") | routing/hostname as Host COUNT_UNIQUE(event_type) as IndicatorCount GROUP BY(Host)
```

## Investigation Workflow

### Key Lessons from Testing:
1. **Start simple, iterate gradually** - Don't jump to complex queries
2. **Verify data exists** - Check with basic queries first
3. **Understand your environment** - What's normal varies greatly
4. **Focus on high-confidence detections** - Admin shares, registry events, and authentication
5. **Renamed binaries are common** - Don't rely on process names alone

### Recommended Approach:

1. **Start with Admin Share Access** [HIGHEST PRIORITY]
   - Run the basic admin share query
   - Note any unusual patterns (e.g., single user accessing many hosts)
   - Check if access times correlate with known maintenance windows
   - This method has proven most reliable across environments

2. **Check PsExec Registry Artifacts** [HIGH PRIORITY]
   - Search for Sysinternals\PsExec\EulaAccepted registry writes
   - Correlate PIDs with process execution events
   - Look for -accepteula in command lines

2. **Correlate with Authentication Events**
   - For each suspicious admin share access, check for corresponding logon events
   - Look for Type 3 (Network) or Type 10 (RDP) logons from the same source

3. **Check for Execution Artifacts**
   - Search for process creation events on target hosts
   - Look for services.exe spawning unusual processes
   - Check for new services or scheduled tasks

4. **Timeline Analysis**
   - Create a timeline of events across multiple hosts
   - Look for rapid sequential access to multiple systems
   - Identify the initial compromise point

## Key Indicators to Monitor

### High Priority (Most Reliable)
- Administrative share access (C$, ADMIN$) from non-admin workstations
- Registry writes to Sysinternals\PsExec\EulaAccepted
- RDP connections (Event ID 4624, LogonType 10)
- Network logons (Event ID 4624, LogonType 3)
- Multiple hosts accessed by single user in short timeframe

### Medium Priority (Environment Dependent)
- Service creation on remote systems
- WMIC with /node: parameter
- Scheduled task creation by non-system accounts
- Command lines with -accepteula flag

### Medium Priority
- RDP connections outside business hours
- WMIC with /node: parameter
- Scheduled task creation by non-system accounts

### Context Considerations
- Some legitimate tools use admin shares (SCCM, deployment tools)
- IT administrators may legitimately access multiple systems
- Consider baseline behavior for each user/system

## Response Actions

When lateral movement is detected:

1. **Immediate Actions**
   - Document all affected systems
   - Capture network connections from source system
   - Preserve logs from both source and target systems

2. **Containment**
   - Consider isolating affected systems
   - Disable compromised accounts
   - Block source IP if external

3. **Investigation**
   - Check for persistence mechanisms on accessed systems
   - Review user account permissions
   - Search for additional compromised accounts

## Automation Opportunities

Consider creating LimaCharlie D&R rules for:
- **Alert on admin share access from non-IT systems** [HIGHEST VALUE]
- **Monitor PsExec registry artifacts** [HIGH VALUE]
- **Monitor authentication anomalies** [HIGH VALUE]
- Flag multiple failed logon attempts followed by success
- Monitor for service creation patterns
- Detect command lines with -accepteula patterns

## Important Reminders

1. **Query Development Best Practices:**
   - Always start with simple queries
   - Verify events exist before adding complex filters
   - Test with small time ranges first
   - Iterate based on results, not assumptions

2. **Environmental Considerations:**
   - Telemetry varies by organization
   - Sysmon greatly enhances detection capabilities
   - Attackers adapt to common detection methods
   - Baseline your environment's normal behavior

3. **Focus Areas:**
   - Prioritize high-confidence detections
   - Admin share access remains most reliable
   - Registry artifacts provide strong evidence
   - Authentication events provide strong signals
   - Don't rely solely on process name detection

## Real-World Example

In our testing, we discovered PsExec renamed to evade detection:
- Registry writes revealed the tool despite renaming
- Command line showed `-accepteula \\\\[HOSTNAME] -c [executable]`
- PIDs matched between registry events and process execution
- This demonstrates why multiple detection methods are crucial

Remember to tune these queries based on your environment's normal behavior and legitimate administrative tools.